BEGIN TRANSACTION;

DROP TABLE orders;
DROP TABLE customers;
DROP TABLE products;

COMMIT;

BEGIN TRANSACTION;

CREATE TABLE IF NOT EXISTS orders (
order_id SERIAL PRIMARY KEY,
customer_id INT,
product_id INT,
created_at TIMESTAMP NOT NULL,
amount NUMERIC(10,2),
status TEXT
);

CREATE INDEX idx_btree_orders_customer_id
ON orders(customer_id);
CREATE INDEX idx_btree_orders_product_id
ON orders(product_id);
DROP INDEX idx_btree_orders_customer_id;
CREATE INDEX idx_hash_orders_customer_id
ON orders USING hash (customer_id);

CREATE TABLE IF NOT EXISTS customers (
customer_id SERIAL PRIMARY KEY,
name TEXT,
email TEXT
);

CREATE TABLE IF NOT EXISTS products (
product_id SERIAL PRIMARY KEY,
name TEXT,
price NUMERIC(10,2)
);

COMMIT;

BEGIN TRANSACTION;

CREATE OR REPLACE FUNCTION orders_add_amount() RETURNS TRIGGER
LANGUAGE plpgsql AS
$$
BEGIN
UPDATE public.orders o
	SET  amount=(SELECT price FROM products p WHERE new.product_id = p.product_id)
	WHERE new.order_id = o.order_id;
RETURN NULL;
END
$$;

CREATE OR REPLACE TRIGGER orders_add_amount_trigger
AFTER INSERT
ON orders
FOR ROW
EXECUTE FUNCTION orders_add_amount();

COMMIT;

BEGIN TRANSACTION;

CREATE TABLE IF NOT EXISTS orders (
order_id SERIAL,
customer_id INT,
product_id INT,
created_at TIMESTAMP NOT NULL,
amount NUMERIC(10,2),
status TEXT,
PRIMARY KEY (order_id, created_at)
) PARTITION BY RANGE (created_at);

CREATE TABLE orders_2023_01 PARTITION OF orders_new
FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

CREATE TABLE orders_2023_02 PARTITION OF orders_new
FOR VALUES FROM ('2023-02-01') TO ('2023-03-01');

CREATE TABLE orders_2023_03 PARTITION OF orders_new
FOR VALUES FROM ('2023-03-01') TO ('2023-04-01');

CREATE TABLE orders_2023_04 PARTITION OF orders_new
FOR VALUES FROM ('2023-04-01') TO ('2023-05-01');

CREATE TABLE orders_2023_05 PARTITION OF orders_new
FOR VALUES FROM ('2023-05-01') TO ('2023-06-01');

CREATE TABLE orders_2023_06 PARTITION OF orders_new
FOR VALUES FROM ('2023-06-01') TO ('2023-07-01');

CREATE TABLE orders_2023_07 PARTITION OF orders_new
FOR VALUES FROM ('2023-07-01') TO ('2023-08-01');

CREATE TABLE orders_2023_08 PARTITION OF orders_new
FOR VALUES FROM ('2023-08-01') TO ('2023-09-01');

CREATE TABLE orders_2023_09 PARTITION OF orders_new
FOR VALUES FROM ('2023-09-01') TO ('2023-10-01');

CREATE TABLE orders_2023_10 PARTITION OF orders_new
FOR VALUES FROM ('2023-10-01') TO ('2023-11-01');

CREATE TABLE orders_2023_11 PARTITION OF orders_new
FOR VALUES FROM ('2023-11-01') TO ('2023-12-01');

CREATE TABLE orders_2023_12 PARTITION OF orders_new
FOR VALUES FROM ('2023-12-01') TO ('2024-01-01');

CREATE TABLE orders_2024_01 PARTITION OF orders_new
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE orders_2024_02 PARTITION OF orders_new
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

CREATE TABLE orders_2024_03 PARTITION OF orders_new
FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

CREATE TABLE orders_2024_04 PARTITION OF orders_new
FOR VALUES FROM ('2024-04-01') TO ('2024-05-01');

CREATE TABLE orders_2024_05 PARTITION OF orders_new
FOR VALUES FROM ('2024-05-01') TO ('2024-06-01');

CREATE TABLE orders_2024_06 PARTITION OF orders_new
FOR VALUES FROM ('2024-06-01') TO ('2024-07-01');

CREATE TABLE orders_2024_07 PARTITION OF orders_new
FOR VALUES FROM ('2024-07-01') TO ('2024-08-01');

CREATE TABLE orders_2024_08 PARTITION OF orders_new
FOR VALUES FROM ('2024-08-01') TO ('2024-09-01');

CREATE TABLE orders_2024_09 PARTITION OF orders_new
FOR VALUES FROM ('2024-09-01') TO ('2024-10-01');

CREATE TABLE orders_2024_10 PARTITION OF orders_new
FOR VALUES FROM ('2024-10-01') TO ('2024-11-01');

CREATE TABLE orders_2024_11 PARTITION OF orders_new
FOR VALUES FROM ('2024-11-01') TO ('2024-12-01');

CREATE TABLE orders_2024_12 PARTITION OF orders_new
FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');

CREATE TABLE orders_2025_01 PARTITION OF orders_new
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE orders_2025_02 PARTITION OF orders_new
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

CREATE TABLE orders_2025_03 PARTITION OF orders_new
FOR VALUES FROM ('2025-03-01') TO ('2025-04-01');

CREATE TABLE orders_2025_04 PARTITION OF orders_new
FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');

CREATE TABLE orders_2025_05 PARTITION OF orders_new
FOR VALUES FROM ('2025-05-01') TO ('2025-06-01');

CREATE TABLE orders_2025_06 PARTITION OF orders_new
FOR VALUES FROM ('2025-06-01') TO ('2025-07-01');

CREATE TABLE orders_2025_07 PARTITION OF orders_new
FOR VALUES FROM ('2025-07-01') TO ('2025-08-01');

CREATE TABLE orders_2025_08 PARTITION OF orders_new
FOR VALUES FROM ('2025-08-01') TO ('2025-09-01');

CREATE TABLE orders_2025_09 PARTITION OF orders_new
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

CREATE TABLE orders_2025_10 PARTITION OF orders_new
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

INSERT INTO orders_new SELECT * FROM orders;

DROP TABLE orders;

ALTER TABLE orders_new RENAME TO orders;
COMMIT;